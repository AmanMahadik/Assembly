%macro read 2
    mov rax,0
    mov rdi,0
    mov rsi,%1
    mov rdx,%2
    syscall
%endmacro

%macro write 2
    mov rax,1
    mov rdi,1
    mov rsi,%1
    mov rdx,%2
    syscall
%endmacro

section .data
menu db 10,"1.String length",10,"2.String concatenation",10,"3.String palindrome",10,"4.Exit",10,"Enter choice: ",0
menulen equ $-menu

msg1 db "Enter String1: ",0
msg1_len equ $-msg1

msg2 db "Enter String2: ",0
msg2_len equ $-msg2

msg_len db "Length (hex): ",10,0
msg_len_len equ $-msg_len

msg_cat db "Concatenated: ",10,0
msg_cat_len equ $-msg_cat

msg_pal db "Palindrome",10,0
msg_pal_len equ $-msg_pal

msg_notpal db "Not Palindrome",10,0
msg_notpal_len equ $-msg_notpal

section .bss
s1 resb 40
s2 resb 40
s3 resb 80
l1 resq 1
l2 resq 1
choice resb 2
buff resb 16

section .text
global _start

_start:
    write msg1,msg1_len
    read s1,40
    dec rax
    mov [l1],rax

    write msg2,msg2_len
    read s2,40
    dec rax
    mov [l2],rax

menu_loop:
    write menu,menulen
    read choice,2

    cmp byte [choice],'1'
    je do_len
    cmp byte [choice],'2'
    je do_cat
    cmp byte [choice],'3'
    je do_pal
    cmp byte [choice],'4'
    je exit
    jmp menu_loop

do_len:
    write msg_len,msg_len_len
    mov rbx,[l1]
    call display
    jmp menu_loop

do_cat:
    mov rsi,s1
    mov rdi,s3
    mov rcx,[l1]
    cld
    rep movsb
    mov rsi,s2
    mov rcx,[l2]
    rep movsb
    mov rbx,[l1]
    add rbx,[l2]
    write msg_cat,msg_cat_len
    write s3,rbx
    jmp menu_loop

do_pal:
    mov rsi,s1
    add rsi,[l1]
    dec rsi
    mov rdi,s3
    mov rcx,[l1]
pal_rev:
    mov dl,[rsi]
    mov [rdi],dl
    dec rsi
    inc rdi
    dec rcx
    jnz pal_rev
    mov rsi,s1
    mov rdi,s3
    mov rcx,[l1]
    cld
    repe cmpsb
    jne notpal
    write msg_pal,msg_pal_len
    jmp menu_loop
notpal:
    write msg_notpal,msg_notpal_len
    jmp menu_loop

exit:
    mov rax,60
    xor rdi,rdi
    syscall

display:
    mov rsi,buff
    mov rcx,16
dloop:
    rol rbx,4
    mov dl,bl
    and dl,0Fh
    cmp dl,9
    jbe ok
    add dl,7
ok:
    add dl,'0'
    mov [rsi],dl
    inc rsi
    dec rcx
    jnz dloop
    write buff,16
    ret
